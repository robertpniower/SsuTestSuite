pipeline {
    agent { label 'kubernetes' }
    environment{
        BASE_JENKINS_URL = 'https://sf-qa-automation.sfplatform.deliveryhero.io/job/Pipelines/job/SSU_V3_Pipelines/job/LATAM_SSU_V3_Pipeline/'
        ALLURE_URL = 'https://sf-qa-automation.sfplatform.deliveryhero.io/job/Pipelines/job/SSU_V3_Pipelines/job/LATAM_SSU_V3_Pipeline/'
        BASE_REPO_URL = 'https://github.com/robertpniower/SsuTestSuite.git'
        STAGEQAAUTO_USERNAME = credentials('STAGEQAAUTO_USERNAME')
        STAGEQAAUTO_KEY = credentials('STAGEQAAUTO_KEY')
        SSU_SF_CLIENT_ID_UAT = credentials('SSU_SF_CLIENT_ID_UAT')
        SSU_SF_CLIENT_SECRET_UAT = credentials('SSU_SF_CLIENT_SECRET_UAT')
        SSU_SF_PASSWORD_UAT = credentials('SSU_SF_PASSWORD_UAT')
        SSU_ENV = 'uat'
        SFENV = 'uat'
    }     
    stages {
        
        stage('Build') {
            steps {
                echo 'Install Dependencies...'
                sh 'rm -r -f node_modules/'
                sh 'rm -f package-lock.json'
                sh 'node --version'
                sh 'npm install'                   
                }
            }

        stage('Test') { 
            steps {
                echo 'Starting Test Automation Suits...'
                sh ('npm run ssu-v3-test')   
                }                    
            }

        // stage('Generating Test Reports...') {
        //     steps {
        //     sh 'npm run report:history && npm run report.ci'
        //     script {
        //             allure([
        //                     includeProperties: false,
        //                     jdk: '',
        //                     properties: [],
        //                     reportBuildPolicy: 'ALWAYS',
        //                     results: [[path: 'target/allure-results']]
        //             ])
        //     }   
        //     }
        // }
    }
    post{
        success{
            echo 'The Automation finish successfully'
        }

        failure{
            echo 'Something went wrong'
    
        }
        always{
            sh 'npm run report:history && npm run report.ci'
           script {
                    allure([
                            includeProperties: false,
                            jdk: '',
                            properties: [],
                            reportBuildPolicy: 'ALWAYS',
                            results: [[path: 'target/allure-results']]
                    ])
            }
        }
    }
}